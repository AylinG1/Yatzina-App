<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Panel Alumno - Y√ÑTZINA</title>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --primary: #2bee4b;
            --background-light: #f6f8f6;
            --background-dark: #102213;
            --card-radius: 1rem;
            --card-radius-lg: 1.5rem;
            --text-dark: #0d1b10;
        }

        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family: 'Spline Sans', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: var(--background-light);
            color: var(--text-dark);
            min-height:100vh;
            padding:24px;
        }

        .header{
            background: rgba(255,255,255,0.9);
            padding:20px;
            border-radius:var(--card-radius-lg);
            margin-bottom:20px;
            display:flex;align-items:center;justify-content:space-between;gap:16px;
            box-shadow:0 8px 24px rgba(16,34,19,0.06);
        }

        .header h1{font-size:24px;color:var(--text-dark);font-weight:700}
        .header p{color:rgba(13,27,16,0.7)}

        .user-info{ text-align:right }
        .btn-logout{
            background:var(--primary);color:var(--text-dark);border:none;padding:10px 18px;border-radius:9999px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(43,230,70,0.18);
        }

        .info-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin-bottom:22px}
        .info-card{background:white;padding:18px;border-radius:var(--card-radius);box-shadow:0 8px 20px rgba(16,34,19,0.04);text-align:center;border:1px solid rgba(13,27,16,0.04)}
        .info-card h3{font-size:16px;margin-bottom:8px;color:rgba(13,27,16,0.8)}
        .info-card p{font-size:28px;font-weight:800;color:var(--primary)}

        .lessons-container{background:white;padding:28px;border-radius:var(--card-radius-lg);box-shadow:0 12px 36px rgba(16,34,19,0.06)}
        .lessons-container h2{text-align:center;margin-bottom:18px;color:var(--text-dark);font-size:20px}

        .lessons-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:18px}
        .lesson-card{background:linear-gradient(180deg,#ffffff 0%, #f3fff6 100%);border:2px solid rgba(43,230,70,0.12);padding:18px;border-radius:20px;color:var(--text-dark);text-align:center;cursor:pointer;transition:transform .2s ease,box-shadow .2s ease}
        .lesson-card:hover{transform:translateY(-6px);box-shadow:0 16px 40px rgba(16,34,19,0.08);}
        .lesson-icon{font-size:42px;margin-bottom:10px}
        .lesson-title{font-weight:700;margin-bottom:10px}

        .progress-bar{background:rgba(13,27,16,0.06);height:10px;border-radius:9999px;overflow:hidden}
        .progress-fill{background:var(--primary);height:100%;width:0;transition:width .3s ease}

        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center}
        .modal-content{background:white;padding:28px;border-radius:20px;max-width:520px;width:92%;text-align:center}
        .btn-close{background:var(--primary);color:var(--text-dark);padding:12px 28px;border-radius:12px;border:none;font-weight:700;cursor:pointer}
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1>üéì Y√ÑTZINA - Mi Panel</h1>
            <p id="welcomeText" style="font-size: 20px; color: #666;">Cargando...</p>
        </div>
        <div class="user-info">
            <p><strong>üë®‚Äçüè´ Maestro:</strong> <span id="maestroNombre">Cargando...</span></p>
            <button onclick="cerrarSesion()" class="btn-logout">Salir</button>
        </div>
    </div>

    <div class="info-cards">
        <div class="info-card">
            <h3>üìä Progreso Total</h3>
            <p id="progresoTotal">0%</p>
        </div>
        <div class="info-card">
            <h3>‚úÖ Lecciones Completadas</h3>
            <p id="leccionesCompletadas">0/7</p>
        </div>
        <div class="info-card">
            <h3>‚≠ê Puntos Totales</h3>
            <p id="puntosTotales">0</p>
        </div>
    </div>

    <div class="lessons-container">
        <h2>üöÄ Mis Lecciones de H√±√§h√±u</h2>
        <div class="lessons-grid">
            <div class="lesson-card" onclick="window.location.href='./lecciones/abecedario.html'">
                <div class="lesson-icon">üìù</div>
                <div class="lesson-title">Abecedario H√±√§h√±u</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-abecedario" style="width: 0%"></div>
                </div>
            </div>

            <div class="lesson-card" onclick="window.location.href='./lecciones/lecturas.html'">
                <div class="lesson-icon">üìñ</div>
                <div class="lesson-title">Lecturas</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-lecturas" style="width: 0%"></div>
                </div>
            </div>

            <div class="lesson-card" onclick="window.location.href='./lecciones/relacionar.html'">
                <div class="lesson-icon">üîó</div>
                <div class="lesson-title">Relacionar</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-relacionar" style="width: 0%"></div>
                </div>
            </div>

            <div class="lesson-card" onclick="window.location.href='./lecciones/saludos.html'">
                <div class="lesson-icon">üó£Ô∏è</div>
                <div class="lesson-title">Conversaciones</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-conversaciones" style="width: 0%"></div>
                </div>
            </div>

            <div class="lesson-card" onclick="window.location.href='./lecciones/lecturas.html'">
                <div class="lesson-icon">üìö</div>
                <div class="lesson-title">Vocabulario</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%"></div>
                </div>
            </div>

            <div class="lesson-card" onclick="window.location.href='./lecciones/PartesDelCuerpo.html'">
                <div class="lesson-icon">üßç</div>
                <div class="lesson-title">Partes del Cuerpo</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-partes-del-cuerpo" style="width: 0%"></div>
                </div>
            </div>

            <div class="lesson-card" onclick="window.location.href='./lecciones/Animales.html'">
                <div class="lesson-icon">üêæ</div>
                <div class="lesson-title">Animales</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-animales" style="width: 100%"></div>
                </div>
            </div>

            <div class="lesson-card" onclick="window.location.href='./lecciones/Numeros.html'">
                <div class="lesson-icon">üî¢</div>
                <div class="lesson-title">N√∫meros</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-numeros" style="width: 100%"></div>
                </div>
            </div>

            <div class="lesson-card" onclick="window.location.href='./lecciones/logros.html'">
                <div class="lesson-icon">üèÜ</div>
                <div class="lesson-title">Mis Logros</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de √©xito eliminado por solicitud del usuario -->

    <script>
        function createStars() {
            const numberOfStars = 40;
            for (let i = 0; i < numberOfStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                const size = Math.random() * 4 + 2;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(star);
            }
        }
        createStars();

        let alumnoData = {};

        async function cargarDatosAlumno() {
            try {
                const response = await fetch('../backend/obtenerDatosAlumno.php');
                const data = await response.json();
                
                if (data.success) {
                    alumnoData = data;
                    document.getElementById('welcomeText').textContent = `Bienvenido, ${data.nombreCompleto}`;
                    document.getElementById('maestroNombre').textContent = data.maestroNombre || 'Sin asignar';
                    cargarProgreso();
                }
            } catch (error) {
                console.log('[v0] Error cargando datos:', error);
            }
        }

        async function cargarProgreso() {
            try {
                const response = await fetch('../backend/obtenerProgresoAlumno.php');
                const data = await response.json();
                
                if (data.success) {
                    let completadas = 0;
                    
                    data.progreso.forEach(leccion => {
                        const progressBar = document.getElementById(`progress-${leccion.leccion}`);
                        if (progressBar) {
                            progressBar.style.width = leccion.porcentaje + '%';
                        }
                        
                        if (leccion.completado) completadas++;
                    });
                    
                    document.getElementById('leccionesCompletadas').textContent = `${completadas}/7`;
                    document.getElementById('progresoTotal').textContent = Math.round((completadas / 7) * 100) + '%';
                    
                    // Cargar puntos totales
                    cargarPuntosTotales();
                }
            } catch (error) {
                console.log('[v0] Error cargando progreso:', error);
            }
        }

        async function cargarPuntosTotales() {
            try {
                const response = await fetch('../backend/obtenerPuntos.php');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('puntosTotales').textContent = data.puntos_totales;
                }
            } catch (error) {
                console.log('[v0] Error cargando puntos:', error);
                document.getElementById('puntosTotales').textContent = '0';
            }
        }

        // Modal de √©xito removido ‚Äî no se muestra nada al completar lecciones

        // Listener para actualizar puntos cuando se registren nuevos puntos desde una lecci√≥n
        document.addEventListener('puntosRegistrados', (event) => {
            cargarPuntosTotales();
            console.log('üéâ Puntos actualizados:', event.detail);
        });

        // Funci√≥n para cerrar sesi√≥n: hace una petici√≥n al endpoint y redirige al index
        // usamos location.replace para reemplazar la entrada en el historial y evitar volver atr√°s
        function cerrarSesion() {
            fetch('../backend/cerrarSesion.php', { method: 'GET', credentials: 'include' })
                .then(async (res) => {
                    try {
                        await res.json();
                    } catch (e) {
                        // ignore parse errors
                    }
                    window.location.replace('../index.html');
                })
                .catch(err => {
                    console.error('Error al cerrar sesi√≥n:', err);
                    window.location.replace('../index.html');
                });
        }

        // Asegurarse de validar sesi√≥n al mostrar la p√°gina (maneja navegaci√≥n "back")
        window.addEventListener('pageshow', (event) => {
            // Siempre revalidar con el servidor
            cargarDatosAlumno();
            if (event.persisted) {
                // Si la p√°gina viene del cache del navegador, forzar recarga
                // para que la comprobaci√≥n de sesi√≥n sea efectiva
                window.location.reload();
            }
        });

        // Auto-refresh cada 5 segundos para mantener puntos actualizados
        setInterval(() => {
            cargarPuntosTotales();
        }, 5000);

        cargarDatosAlumno();
    </script>
    <script src="./notificacionesPuntos.js"></script>

</body>
</html>